name: Extract and Package Fastboot Firmware

on:
    workflow_dispatch:
        inputs:
            fileurl:
                description: 'link of full OxygenOS/ColorOS file'
                required: true
                type: string

env:
    GH_TOKEN: ${{ github.token }}

jobs:
    extracting-boot:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@main
            
            - name: Set up Environment
              run: |
                sudo apt-get update
                sudo apt-get install -y aria2 p7zip-full
            
            - name: Downloading otadump    
              run: |
                wget -O otadump.tar.gz https://github.com/crazystylus/otadump/releases/download/0.1.2/otadump-0.1.2-x86_64-unknown-linux-gnu.tar.gz
                tar xvf otadump.tar.gz
                chmod +x otadump

            - name: Downloading OTA
              run: aria2c -o ota.zip --user-agent='Dalvik/2.1.0 (Linux; U; Android 15; CPH2585 Build/AQ3A.241114.001)' -x 16 "${{ github.event.inputs.fileurl }}"
            
            - name: Extracting payload.bin
              run: unzip ota.zip payload.bin META-INF/*
                
            - name: Setting up Release name
              run: |  
                REL_NAME=$(grep "version_name=" META-INF/com/android/metadata | sed 's/^[^=]*=//')
                echo "REL_NAME=$REL_NAME" >> $GITHUB_ENV
            
            - name: Dumping firmware and organizing structure
              run: | 
                # 定义要提取的分区列表
                PARTITIONS="abl,aop_config,aop,bluetooth,cpucp,cpucp_dtb,devcfg,dsp,engineering_cdt,featenabler,hyp,imagefv,keymaster,modem,oplus_sec,oplusstanvbk,qupfw,shrm,splash,tz,uefi,uefisecapp,xbl_config,xbl_ramdump,xbl"
                
                # 提取分区
                ./otadump payload.bin --partitions $PARTITIONS
                
                # 建立图片所示的目录结构
                mkdir -p output_firmware/platform-tools
                
                # 移动镜像文件到根目录
                mv extracted*/*.img output_firmware/
                
                # 下载 Windows 版 platform-tools (以便在 Windows 下直接运行)
                wget https://dl.google.com/android/repository/platform-tools-latest-windows.zip
                unzip platform-tools-latest-windows.zip -d temp_pt
                mv temp_pt/platform-tools/fastboot.exe output_firmware/platform-tools/
                mv temp_pt/platform-tools/AdbWinApi.dll output_firmware/platform-tools/
                mv temp_pt/platform-tools/AdbWinUsbApi.dll output_firmware/platform-tools/

            - name: Creating Flash Script
              run: |
                # 动态生成 flash_all.bat
                cat << 'EOF' > output_firmware/flash_all.bat
                @echo off
                cd /d "%~dp0"
                title Fastboot_Flasher
                set FB="platform-tools\fastboot.exe"
                echo ===================================
                echo STEP 1: Checking Device...
                %FB% devices
                echo ===================================
                echo STEP 2: Rebooting to Fastbootd...
                %FB% reboot fastboot
                timeout /t 10
                echo STEP 3: Flashing Images...
                EOF

                # 自动将所有 img 文件写入闪存脚本
                for img in output_firmware/*.img; do
                    filename=$(basename "$img")
                    partition="${filename%.img}"
                    echo "%FB% flash --slot=all $partition $filename" >> output_firmware/flash_all.bat
                done

                echo -e "echo DONE!\n%FB% reboot\npause" >> output_firmware/flash_all.bat

            - name: 7z Solid Compression
              run: |
                # 使用 7z 固实压缩 (-ms=on)
                cd output_firmware
                7z a -t7z -m0=lzma2 -mx=9 -ms=on ../fastboot_firmware.7z ./*

            - name: Creating release
              run: |
                gh release create "$REL_NAME" --title "$REL_NAME" --notes "Fastboot Firmware generated by Actions" fastboot_firmware.7z